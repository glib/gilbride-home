---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Container from '../components/Container.astro';
import PostCard from '../components/PostCard.astro';
import FeaturedPostCard from '../components/FeaturedPostCard.astro';
import PostTimeline from '../components/PostTimeline.astro';
import { getCollection } from 'astro:content';
import { createPostSummary } from '../utils/contentSummary';
import { calculateReadingTime } from '../utils/readingTime';

const posts = await Promise.all(
  (await getCollection('blog', ({ data }) => import.meta.env.PROD ? !data.draft : true))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .map(async (post) => {
      const { Content } = await post.render();
      const { summary } = createPostSummary(post.body, 400);
      const readingTime = calculateReadingTime(post.body);
      return { ...post, Content, summary, readingTime };
    })
);

// Featured posts (first 3 most recent)
const featuredPosts = posts.slice(0, 3);

// All posts for timeline
const timelinePosts = posts;
---

<BaseLayout 
  title="Work From Loam - Remote Work & Mountain Biking"
  description="A blog and YouTube channel about remote work in tech, game development, and mountain biking adventures."
>
  <Header currentPath="/" />

  <main>
    <Container class="py-8">
      <!-- Browse All Posts Link -->
      <div class="flex justify-end mb-6">
        <a 
          href="/posts" 
          class="inline-flex items-center text-sm font-heading font-medium text-highlight hover:text-highlight/80 transition-colors"
        >
          Browse all posts
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>
      </div>

      <!-- Main Content Grid: Posts Column + Timeline Column -->
      {featuredPosts.length > 0 && (
        <div class="grid lg:grid-cols-3 gap-8">
          <!-- Posts Column (Main + Secondary Posts + CTA) -->
          <div class="lg:col-span-2 space-y-8">
            <!-- Featured Post (Latest) -->
            <PostCard 
              slug={featuredPosts[0].slug}
              title={featuredPosts[0].data.title}
              pubDate={featuredPosts[0].data.pubDate}
              tags={featuredPosts[0].data.tags}
              youtubeId={featuredPosts[0].data.youtubeId}
              heroImage={featuredPosts[0].data.heroImage}
              summary={featuredPosts[0].summary}
              readingTime={featuredPosts[0].readingTime}
              class="border-l-4 border-l-highlight bg-secondary/30 p-6 rounded-r-lg"
            />
            
            <!-- Secondary Featured Posts -->
            {featuredPosts.length > 1 && (
              <div class="grid md:grid-cols-2 gap-6">
                {featuredPosts.slice(1, 3).map((post) => (
                  <FeaturedPostCard 
                    slug={post.slug}
                    title={post.data.title}
                    youtubeId={post.data.youtubeId}
                    heroImage={post.data.heroImage}
                  />
                ))}
              </div>
            )}
            
            <!-- Call to Action -->
            <div class="bg-secondary rounded-lg p-6 border border-tertiary text-center">
              <h3 class="text-xl font-heading font-semibold text-text-primary mb-3">
                Join the Adventure
              </h3>
              <p class="text-text-primary mb-4 leading-relaxed">
                Follow along as we explore remote work strategies, game development insights, and mountain biking adventures.
              </p>
              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <a 
                  href="https://youtube.com/@workfromloam" 
                  target="_blank" 
                  rel="noopener"
                  class="inline-flex items-center justify-center px-6 py-2 bg-highlight text-primary font-heading font-medium rounded-md hover:bg-highlight/80 transition-colors"
                >
                  <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/>
                    <path fill="white" d="M9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                  </svg>
                  Watch on YouTube
                </a>
                <a 
                  href="/about" 
                  class="inline-flex items-center justify-center px-6 py-2 bg-secondary border border-tertiary text-text-primary font-heading font-medium rounded-md hover:bg-tertiary transition-colors"
                >
                  Learn More
                </a>
              </div>
            </div>
          </div>
          
          <!-- Timeline Column (Extended) -->
          <div class="lg:col-span-1">
            <PostTimeline posts={timelinePosts} limit={15} />
          </div>
        </div>
      )}
    </Container>
  </main>

  <Footer />
</BaseLayout>